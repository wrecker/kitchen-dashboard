<html>
<head>

  <title>Maithri List</title>

  <meta name="robots" content="noindex, nofollow">
  <link href="https://fonts.googleapis.com/css?family=Josefin+Sans" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600" rel="stylesheet" type="text/css">

  <link rel="stylesheet" media="all" href="css/list-application.css">
  <meta name="viewport" content="width=device-width, user-scalable=0, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0">
  <link rel="shortcut icon" href="/favicon.png">
  <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-startup-image" href="/iphone.png" media="screen and (max-device-width: 360px)">

</head>

<body class="lists lists-show list-is-selected" style="cursor: auto;">

  <div class="show desktop">

    <div class="selected-list paper">
      <div class="list-header">
        <h2 class="list-title"></h2>
      </div>

      <div class="list">
        <ul class="items ui-sortable">

        </ul>
        <ul class="add-item">
          <li>
            <form class="add-item-form">
              <input class="chromeless-input" placeholder="Add to your list..." type="text" name="content">
            </form>
          </li>
        </ul>
        <ul style="display:none">
          <li class="clearfix todo clone-source">
            <button class="toggle" title="Check!" alt="Check!" tabindex="0">
                <svg class="icon-check"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="img/icons.svg#icon-check"></use></svg>
            </button>
            <div class="view">
              <label class="label" tabindex="0" contenteditable="true"></label>
            </div>
            <svg class="destroy icon-trash-o"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="img/icons.svg#icon-trash-o"></use></svg>
          </li>
        </ul>
      </div>
    </div>
  </div>
</body>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script type="text/javascript">

$(function() {
  queryParams = getUrlQueryParams();
  display = queryParams["display"] || 1;
  if (display) {
    $(".items").on("focusin", ".label", function(e) { beginEditing(this); });

    $(".items").on("focusout", ".label", function(e) {
      finishEditing(this);
    });

    $(".items").on("click", ".toggle", function(e) {
      toggleTaskStatus($(this).closest("li"));
    });

    $(".items").on("click", ".destroy", function(e) {
      deleteTask($(this).closest("li"));
    });

    $(".items").on("keydown", ".label", function(e) {
      if(e.keyCode == 13) {
        e.preventDefault();
        finishEditing(this);
        $(this).blur();
      }
    });

    $(".add-item-form").submit(addNewTask);
  }
  getData();
})

// https://stackoverflow.com/questions/4656843/jquery-get-querystring-from-url
function getUrlQueryParams()
{
    var params = [], hash;
    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
    for(var i = 0; i < hashes.length; i++)
    {
        hash = hashes[i].split('=');
        params.push(hash[0]);
        params[hash[0]] = hash[1];
    }
    return params;
}

function getListId() {
  queryParams = getUrlQueryParams();
  return queryParams["listId"] || 1
}

function addNewTask(e) {
  e.preventDefault();
  var data = {};
  var Form = this;

  $.each(this.elements, function(i, v){
    var input = $(v);
    data[input.attr("name")] = input.val();
    delete data["undefined"];
  });

  if (!data["content"]) {
    return;
  }
  listId = getListId();
  taskUrl = location.protocol + "//" + location.host + "/list/" + listId + "/tasks";
  //Save Form Data.
  $.ajax({
      cache: false,
      url : taskUrl,
      type: "POST",
      contentType: "application/json; charset=utf-8",
      dataType : "json",
      data : JSON.stringify(data),
      context : Form,
      success : function(data, textStatus, jqXHR){
          //Where $(this) => context == FORM
          $(this).find("input[type=text], textarea").val("");
          task = jqXHR.responseJSON.task;
          addTask(task);
      },
  });
}

function toggleTaskStatus(row) {
  data = {"done": false};
  if (! $(row).hasClass("completed")) {
      data["done"] = true;
  }
  taskId = $(row).data("taskId");
  taskUrl = location.protocol + "//" + location.host + "/tasks/" + taskId;

  $.ajax(
    {
      url : taskUrl,
      type: "PUT",
      contentType: "application/json; charset=utf-8",
      dataType: "json",
      data: JSON.stringify(data),
      context: row,
      success: function(data, textStatus, jqXHR) {
        console.log("toggleTaskStatus: Task updated.")
        $(row).toggleClass("completed");
      },
      error: function(jqXHR, textStatus, errorThrown) {
        // Restore the original content
        console.log("toggleTaskStatus: Task update Failed: " + errorThrown);
      }
    });
}

function deleteTask(row) {
  taskId = $(row).data("taskId");
  taskUrl = location.protocol + "//" + location.hos + "/tasks/" + taskId;
  $.ajax(
    {
      url : taskUrl,
      type: "DELETE",
      context: row,
      success: function(data, textStatus, jqXHR) {
        console.log("deleteTask: Task deleted.")
        $(row).hide().remove();
      },
      error: function(jqXHR, textStatus, errorThrown) {
        // Restore the original content
        console.log("deleteTask: Task deleted failed: " + errorThrown);
      }
    });
}

function beginEditing(label) {
  // Save the current value to check later
  currContent = $(label).text();
  $(label).closest("li").data("content", currContent);
  $(label).closest("li").addClass("editing");
}

function finishEditing(label) {
  li = $(label).closest("li");
  taskId = $(li).data("taskId");
  listId = $(li).data("listId");
  currContent = $(label).text();
  prevContent = $(li).data("content");
  taskUrl = location.protocol + "//" + location.host + "/tasks/" + taskId;

  var data = {};
  data["content"] = $(label).text();

  if (currContent != prevContent) {
    console.log($(li).find(".label").text() + " " + listId + " " + taskId);
    $.ajax(
  		{
  			url : taskUrl,
  			type: "PUT",
        contentType: "application/json; charset=utf-8",
  			dataType: "json",
        data: JSON.stringify(data),
        context: li,
        success: function(data, textStatus, jqXHR) {
          console.log("finishEditing: Task updated.")
  			},
        error: function(jqXHR, textStatus, errorThrown) {
          // Restore the original content
          $(this).find(".label").text($(this).data("content"));
          console.log("finishEditing: Task update Failed: " + errorThrown);
        }
  		});

  } else {
    console.log("No Change in content");
  }
  $(li).removeClass("editing");
}

function getData() {

  queryParams = getUrlQueryParams();
  listId = queryParams["listId"] || 1
  taskUrl = location.protocol + "//" + location.host + "/list/" + listId + "/tasks";

  $.ajax(
		{
			url : taskUrl,
			type: "GET",
			dataType: "json",
      success:function(data, textStatus, jqXHR)
			{
        list = jqXHR.responseJSON.list;
        $(".list-title").text(list.title);
        tasks = jqXHR.responseJSON.tasks;
        tasks.sort(function(a,b){
          return a.sort_order - b.sort_order;
        });
        $(".items").empty();
        tasks.forEach(function(item, index) {
          addTask(item);
        });
			}
		});
}

function addTask(task) {
  cloned = $(".clone-source").clone().removeClass("clone-source");
  $(cloned).find(".label").html(task.content);
  $(cloned).data("listId", task.list_id);
  $(cloned).data("taskId", task.id);
  if (task.done) {
    $(cloned).addClass("completed");
  }
  $(".items").append(cloned);
}

function jsonCallback(json){
  content = JSON.parse(json.content);
  console.log(content);
}
</script>

</html>
